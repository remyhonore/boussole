name: Boussole — Deploy to Plesk (FTPS)

on:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: boussole-deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare deploy bundle (only production files)
        run: |
          set -euo pipefail

          rm -rf .deploy
          mkdir -p .deploy

          # Root files (keep only what is served publicly)
          for f in index.html en.html boussole_suivi_projet.html README_DEPLOY.txt; do
            if [ -f "$f" ]; then cp -f "$f" .deploy/; fi
          done

          # Main folders served publicly
          if [ -d "app" ]; then
            mkdir -p .deploy/app
            rsync -a --delete app/ .deploy/app/
          fi

          if [ -d "assets" ]; then
            mkdir -p .deploy/assets
            rsync -a --delete assets/ .deploy/assets/
          fi

      - name: Deploy via FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}

          # FTPS explicit (souvent requis en hébergement mutualisé/Plesk)
          protocol: ftps
          port: 21

          # Certificat parfois auto-signé / hostname mismatch -> on tolère
          security: loose

          # Plus robuste sur connexions instables
          timeout: 120000
          log-level: standard

          local-dir: ./.deploy/
          server-dir: ${{ secrets.FTP_REMOTE_DIR }}
