name: Boussole — Deploy to Plesk (FTP)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      ref:
        description: "Tag ou branche à déployer (ex: v0.7.20 ou main)"
        required: false
        default: "main"

concurrency:
  group: boussole-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Choose ref
        id: ref
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "ref=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${{ inputs.ref }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout (selected ref)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ steps.ref.outputs.ref }}

      - name: Prepare deploy payload
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _deploy
          rsync -a --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            --exclude "scripts/" \
            --exclude "dist/" \
            --exclude "__MACOSX/" \
            --exclude "*.DS_Store" \
            ./ _deploy/

      - name: FTP Deploy to Plesk
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: ${{ secrets.FTP_REMOTE_DIR }}
          local-dir: _deploy/
          dangerous-clean-slate: false
