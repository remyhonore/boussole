<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Articles ‚Äî Boussole</title>
    <meta name="theme-color" content="#e09c8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #e09c8a;
            --color-primary-dark: #c97d6a;
            --color-primary-light: #f5e6e1;
            --color-bg: #fafaf8;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-text-muted: #6b6b6b;
            --color-border: #ebebeb;
            --color-green: #4caf7d;
            --color-orange: #f0a055;
            --font-body: 'DM Sans', system-ui, sans-serif;
            --font-serif: 'Lora', Georgia, serif;
            --radius-card: 14px;
            --radius-btn: 10px;
            --shadow-card: 0 2px 12px rgba(0,0,0,0.07);
            --shadow-hover: 0 6px 24px rgba(0,0,0,0.12);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            max-width: 680px;
            margin: 0 auto;
            padding: 16px;
            -webkit-font-smoothing: antialiased;
        }

        /* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
        .header {
            text-align: center;
            padding: 24px 0;
        }
        .header h1 {
            font-family: var(--font-serif);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .header p {
            font-size: 14px;
            color: var(--color-text-muted);
        }

        /* ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê */
        .nav {
            display: flex;
            gap: 8px;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 24px;
        }
        .nav-btn {
            flex: 1;
            padding: 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--color-text-muted);
            font-size: 16px;
            font-family: var(--font-body);
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn:hover { color: var(--color-text); background: rgba(224,156,138,0.05); }
        .nav-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            font-weight: 600;
        }

        /* ‚ïê‚ïê‚ïê BARRE INSCRIT ‚ïê‚ïê‚ïê */
        .subscriber-bar {
            display: none;
            background: linear-gradient(135deg, #e8f7ef, #d4f0e2);
            border-radius: var(--radius-btn);
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #2d7a50;
            margin-bottom: 20px;
        }
        .subscriber-bar.visible { display: block; }

        /* ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê */
        .search-wrap {
            position: relative;
            margin-bottom: 16px;
        }
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: var(--color-text-muted);
            pointer-events: none;
        }
        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-btn);
            background: var(--color-surface);
            font-family: var(--font-body);
            font-size: 15px;
            color: var(--color-text);
            outline: none;
            transition: border-color 0.2s;
        }
        .search-input:focus { border-color: var(--color-primary); }
        .search-input::placeholder { color: var(--color-text-muted); }

        /* ‚ïê‚ïê‚ïê CHIPS FILTRES ‚ïê‚ïê‚ïê */
        .filters {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            margin-bottom: 20px;
            scrollbar-width: none;
        }
        .filters::-webkit-scrollbar { display: none; }
        .chip {
            flex-shrink: 0;
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            font-family: var(--font-body);
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .chip:hover { border-color: var(--color-primary); color: var(--color-primary); }
        .chip.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #fff;
        }

        /* ‚ïê‚ïê‚ïê CARDS FEED ‚ïê‚ïê‚ïê */
        .feed { display: flex; flex-direction: column; gap: 16px; }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-card);
            overflow: hidden;
            cursor: pointer;
            transition: box-shadow 0.2s, transform 0.2s;
            animation: cardIn 0.3s ease both;
        }
        .card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        .card:active { transform: scale(0.99); }

        @keyframes cardIn {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .card-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
            background: var(--color-primary-light);
        }
        .card-emoji-cover {
            width: 100%;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 52px;
            background: linear-gradient(135deg, var(--color-primary-light), #ffe8d6);
        }
        .card-body { padding: 16px; }
        .card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .access-badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        .access-badge.public  { background: #e8f7ef; color: #2d7a50; }
        .access-badge.inscrit { background: #fff3e0; color: #b06000; }
        .access-badge.premium { background: #f3e5f5; color: #7b1fa2; }
        .card-category {
            font-size: 12px;
            color: var(--color-text-muted);
            font-weight: 500;
        }
        .card-readtime {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-left: auto;
        }
        .card-title {
            font-family: var(--font-serif);
            font-size: 17px;
            font-weight: 600;
            line-height: 1.35;
            margin-bottom: 8px;
            color: var(--color-text);
        }
        .card-excerpt {
            font-size: 14px;
            color: var(--color-text-muted);
            line-height: 1.5;
        }
        .card-lock {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--color-border);
            font-size: 13px;
            color: var(--color-text-muted);
        }

        /* ‚ïê‚ïê‚ïê SKELETON ‚ïê‚ïê‚ïê */
        .skeleton-card {
            background: var(--color-surface);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }
        .skeleton-img { width: 100%; height: 160px; background: #eee; }
        .skeleton-body { padding: 16px; }
        .skeleton-line {
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(90deg, #eee 25%, #f5f5f5 50%, #eee 75%);
            background-size: 200% 100%;
            animation: shimmer 1.4s infinite;
            margin-bottom: 10px;
        }
        .skeleton-line.short { width: 40%; }
        .skeleton-line.med   { width: 70%; }
        .skeleton-line.full  { width: 100%; }
        @keyframes shimmer {
            0%   { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ‚ïê‚ïê‚ïê EMPTY STATE ‚ïê‚ïê‚ïê */
        .empty-state {
            text-align: center;
            padding: 48px 16px;
            color: var(--color-text-muted);
        }
        .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
        .empty-state p { font-size: 15px; }

        /* ‚ïê‚ïê‚ïê MODALE ARTICLE ‚ïê‚ïê‚ïê */
        .overlay {
            position: fixed;
            inset: 0;
            background: var(--color-bg);
            z-index: 100;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
        }
        .overlay.open { transform: translateY(0); }

        .overlay-nav {
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(250,250,248,0.95);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--color-border);
        }
        .btn-back {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: var(--color-text);
            line-height: 1;
            padding: 4px;
        }
        .overlay-title {
            flex: 1;
            font-family: var(--font-serif);
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--color-text);
        }
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: var(--color-primary);
            width: 0%;
            z-index: 200;
            transition: width 0.1s linear;
        }

        .article-hero-img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            display: block;
        }
        .article-hero-emoji {
            width: 100%;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            background: linear-gradient(135deg, var(--color-primary-light), #ffe8d6);
        }
        .article-body {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            max-width: 680px;
            width: calc(100% - 32px);
            margin: 16px auto 40px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        }
        .article-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .article-date {
            font-size: 13px;
            color: var(--color-text-muted);
        }
        .article-readtime {
            font-size: 13px;
            color: var(--color-text-muted);
        }
        .article-title {
            font-family: var(--font-serif);
            font-size: 22px;
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 12px;
        }
        .article-excerpt {
            font-family: var(--font-serif);
            font-style: italic;
            font-size: 15px;
            line-height: 1.6;
            color: var(--color-text-muted);
            border-left: 3px solid var(--color-primary);
            padding-left: 14px;
            margin-bottom: 24px;
        }
        .article-content {
            font-size: 15px;
            line-height: 1.7;
        }
        .article-content h2 {
            font-family: var(--font-serif);
            font-size: 19px;
            font-weight: 600;
            margin: 28px 0 12px;
            color: var(--color-text);
        }
        .article-content h3 {
            font-family: var(--font-serif);
            font-size: 16px;
            font-weight: 600;
            margin: 20px 0 10px;
            color: var(--color-text);
        }
        .article-content p { margin-bottom: 14px; }
        .article-content ul, .article-content ol {
            margin: 0 0 14px 20px;
        }
        .article-content li { margin-bottom: 6px; }
        .article-content blockquote {
            margin: 20px 0;
            padding: 14px 16px;
            background: var(--color-primary-light);
            border-left: 3px solid var(--color-primary);
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        .article-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 13px;
        }
        .article-content th {
            background: var(--color-primary-light);
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--color-primary);
        }
        .article-content td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--color-border);
        }
        .article-content tr:hover td { background: #faf5f3; }
        .article-content hr {
            border: none;
            border-top: 1px solid var(--color-border);
            margin: 28px 0;
        }

        /* ‚ïê‚ïê‚ïê EMAIL GATE ‚ïê‚ïê‚ïê */
        .gate-wrap {
            position: relative;
        }
        .gate-fade {
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to bottom, transparent, var(--color-bg));
            pointer-events: none;
        }
        .gate-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            padding: 24px;
            text-align: center;
            box-shadow: var(--shadow-card);
        }
        .gate-icon { font-size: 36px; margin-bottom: 12px; }
        .gate-title {
            font-family: var(--font-serif);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .gate-perks {
            list-style: none;
            margin: 12px 0 20px;
            text-align: left;
        }
        .gate-perks li {
            font-size: 14px;
            color: var(--color-text-muted);
            padding: 3px 0;
        }
        .gate-perks li::before { content: "‚úì "; color: var(--color-green); font-weight: 600; }
        .gate-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-btn);
            font-family: var(--font-body);
            font-size: 15px;
            margin-bottom: 10px;
            outline: none;
            transition: border-color 0.2s;
        }
        .gate-input:focus { border-color: var(--color-primary); }
        .gate-btn {
            width: 100%;
            padding: 13px;
            background: var(--color-primary);
            color: #fff;
            border: none;
            border-radius: var(--radius-btn);
            font-family: var(--font-body);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .gate-btn:hover { background: var(--color-primary-dark); }
        .gate-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .gate-disclaimer {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-top: 10px;
        }
        .gate-success {
            display: none;
            color: var(--color-green);
            font-weight: 600;
            font-size: 15px;
            padding: 12px;
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="header">
        <h1>Articles</h1>
        <p>La science au service de votre sant√©</p>
    </header>

    <!-- NAVIGATION -->
    <nav class="nav" role="navigation">
        <a class="nav-btn" href="/" aria-label="Aller √† la page Aujourd'hui">Aujourd'hui</a>
        <a class="nav-btn" href="/?panel=summary" aria-label="Aller √† la page R√©sum√©">R√©sum√©</a>
        <a class="nav-btn active" href="/articles.html" aria-label="Articles" aria-current="page">Articles</a>
    </nav>

    <!-- BARRE INSCRIT -->
    <div class="subscriber-bar" id="subscriber-bar">
        ‚úì Acc√®s complet aux articles ‚Äî bienvenue !
    </div>

    <!-- RECHERCHE -->
    <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input type="search" class="search-input" id="search-input" placeholder="Rechercher un article‚Ä¶" autocomplete="off">
    </div>

    <!-- FILTRES CAT√âGORIES -->
    <div class="filters" id="filters-wrap"></div>

    <!-- FEED -->
    <div class="feed" id="feed"></div>

    <!-- MODALE ARTICLE -->
    <div class="overlay" id="article-overlay" role="dialog" aria-modal="true">
        <div class="progress-bar" id="progress-bar"></div>
        <nav class="overlay-nav">
            <button class="btn-back" id="btn-back" aria-label="Retour">‚Üê</button>
            <span class="overlay-title" id="overlay-title"></span>
            <span id="overlay-badge"></span>
        </nav>
        <div id="article-content-wrap"></div>
    </div>

    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const CONFIG = {
        jsonPath: '/articles.json',
        brevoFormURL: 'https://ffd96913.sibforms.com/serve/MUIFAJUmjQTMcr8EIjmLErqYjjECrQ73i0aPhf_n6tBk2T-Z5AzjIeTGaQAcaPFU0Gg_yPaV46hxNb6EtRVWlzHZOM4fH08S6nOFuz5CNcfhisSD5UFAsEOsTMl8w405AGiQRhn3MyOfmYSaCUtoAMGqVRzRXKkdXN2kjT-18CVH688z0YTCeL_NKQzYUcFCGw44EksGyMRhKlBtUw==',
        storageKey: 'boussole_email_verified'
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const state = {
        articles: [],
        filtered: [],
        activeCategory: 'all',
        searchQuery: '',
        isSubscriber: localStorage.getItem(CONFIG.storageKey) === 'true',
        searchTimer: null
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UTILS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function formatDate(str) {
        return new Date(str).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function canAccess(article) {
        if (article.access === 'public') return true;
        if (article.access === 'inscrit') return state.isSubscriber;
        return false; // premium
    }

    function getEmoji(article) {
        const t = (article.title + ' ' + article.category).toLowerCase();
        if (t.includes('m√©nopause') || t.includes('menopause')) return 'üå°Ô∏è';
        if (t.includes('pem') || t.includes('effort') || t.includes('crash')) return '‚ö°';
        if (t.includes('dysautonomie') || t.includes('pilote')) return 'ü´Ä';
        if (t.includes('covid') || t.includes('viral')) return 'üß¨';
        if (t.includes('fer') || t.includes('ferritine') || t.includes('normal')) return 'üî¨';
        if (t.includes('sommeil')) return 'üò¥';
        if (t.includes('cerveau') || t.includes('mental')) return 'üß†';
        return 'üìñ';
    }

    function badgeLabel(access) {
        return { public: 'Gratuit', inscrit: 'Inscrit', premium: 'Premium' }[access] || 'Gratuit';
    }

    function truncateHTML(html, percent) {
        const div = document.createElement('div');
        div.innerHTML = html;
        const nodes = div.querySelectorAll('p, h2, h3, li, blockquote');
        const cut = Math.max(1, Math.floor(nodes.length * percent));
        let result = '';
        nodes.forEach((n, i) => { if (i < cut) result += n.outerHTML; });
        return result || html.substring(0, 600);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LOAD DATA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadArticles() {
        showSkeletons();
        try {
            const res = await fetch(CONFIG.jsonPath);
            if (!res.ok) throw new Error('fetch failed');
            state.articles = await res.json();
            state.filtered = [...state.articles];
            buildFilters();
            renderCards();
            if (state.isSubscriber) {
                document.getElementById('subscriber-bar').classList.add('visible');
            }
        } catch(e) {
            showEmpty('üì°', 'Impossible de charger les articles.');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FILTERS & SEARCH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function buildFilters() {
        const categories = [...new Set(state.articles.map(a => a.category))];
        const wrap = document.getElementById('filters-wrap');
        wrap.innerHTML = '';
        const allChip = document.createElement('button');
        allChip.className = 'chip active';
        allChip.textContent = 'Tous';
        allChip.addEventListener('click', () => setCategory('all'));
        wrap.appendChild(allChip);
        categories.forEach(cat => {
            const chip = document.createElement('button');
            chip.className = 'chip';
            chip.textContent = cat;
            chip.addEventListener('click', () => setCategory(cat));
            wrap.appendChild(chip);
        });
    }

    function setCategory(cat) {
        state.activeCategory = cat;
        document.querySelectorAll('.chip').forEach(c => {
            c.classList.toggle('active',
                cat === 'all' ? c.textContent === 'Tous' : c.textContent === cat
            );
        });
        applyFilters();
    }

    function applyFilters() {
        let list = [...state.articles];
        if (state.activeCategory !== 'all') {
            list = list.filter(a => a.category === state.activeCategory);
        }
        if (state.searchQuery) {
            const q = state.searchQuery.toLowerCase();
            list = list.filter(a =>
                a.title.toLowerCase().includes(q) ||
                a.excerpt.toLowerCase().includes(q) ||
                a.category.toLowerCase().includes(q)
            );
        }
        state.filtered = list;
        renderCards();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RENDER CARDS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showSkeletons() {
        const feed = document.getElementById('feed');
        feed.innerHTML = [0,1,2].map(() => `
            <div class="skeleton-card">
                <div class="skeleton-img"></div>
                <div class="skeleton-body">
                    <div class="skeleton-line short"></div>
                    <div class="skeleton-line med"></div>
                    <div class="skeleton-line full"></div>
                </div>
            </div>
        `).join('');
    }

    function showEmpty(icon, msg) {
        document.getElementById('feed').innerHTML = `
            <div class="empty-state">
                <div class="icon">${icon}</div>
                <p>${msg}</p>
            </div>`;
    }

    function renderCards() {
        const feed = document.getElementById('feed');
        if (!state.filtered.length) {
            showEmpty('üîç', 'Aucun article trouv√©.');
            return;
        }
        feed.innerHTML = '';
        state.filtered.forEach((article, idx) => {
            const locked = !canAccess(article);
            const card = document.createElement('div');
            card.className = 'card';
            card.style.animationDelay = `${idx * 0.05}s`;
            card.setAttribute('role', 'button');
            card.setAttribute('aria-label', article.title);

            const coverHTML = article.cover
                ? `<img class="card-img" src="${article.cover}" alt="" loading="lazy">`
                : `<div class="card-emoji-cover">${getEmoji(article)}</div>`;

            const lockHTML = locked ? `
                <div class="card-lock">
                    <span>üîí</span>
                    <span>${article.access === 'premium' ? 'Disponible dans Boussole+' : 'Inscris-toi pour lire cet article'}</span>
                </div>` : '';

            card.innerHTML = `
                ${coverHTML}
                <div class="card-body">
                    <div class="card-meta">
                        <span class="access-badge ${article.access}">${badgeLabel(article.access)}</span>
                        <span class="card-category">${article.category}</span>
                        <span class="card-readtime">‚è± ${article.readtime} min</span>
                    </div>
                    <div class="card-title">${article.title}</div>
                    <div class="card-excerpt">${article.excerpt}</div>
                    ${lockHTML}
                </div>`;

            card.addEventListener('click', () => openArticle(article));
            feed.appendChild(card);
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ARTICLE OVERLAY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function openArticle(article) {
        const overlay = document.getElementById('article-overlay');
        document.getElementById('overlay-title').textContent = article.title;
        document.getElementById('overlay-badge').innerHTML =
            `<span class="access-badge ${article.access}">${badgeLabel(article.access)}</span>`;

        const locked = !canAccess(article);
        let contentHTML;

        if (article.access === 'premium') {
            const preview = truncateHTML(article.content, 0.25);
            contentHTML = buildPremiumGate(article, preview);
        } else if (locked) {
            const preview = truncateHTML(article.content, 0.35);
            contentHTML = buildEmailGate(article, preview);
        } else {
            contentHTML = buildFullArticle(article);
        }

        document.getElementById('article-content-wrap').innerHTML = contentHTML;

        if (!locked) {
            const form = document.getElementById('gate-form-' + article.id);
            if (form) setupGateForm(form, article);
        } else {
            const form = document.getElementById('gate-form-' + article.id);
            if (form) setupGateForm(form, article);
        }

        overlay.classList.add('open');
        overlay.scrollTop = 0;
        document.body.style.overflow = 'hidden';

        // Progress bar
        overlay.addEventListener('scroll', updateProgress, { passive: true });
    }

    function buildFullArticle(article) {
        const coverHTML = article.cover
            ? `<img class="article-hero-img" src="${article.cover}" alt="">`
            : `<div class="article-hero-emoji">${getEmoji(article)}</div>`;
        return `
            ${coverHTML}
            <div class="article-body">
                <div class="article-meta">
                    <span class="access-badge ${article.access}">${badgeLabel(article.access)}</span>
                    <span class="article-date">${formatDate(article.date)}</span>
                    <span class="article-readtime">¬∑ ${article.readtime} min de lecture</span>
                </div>
                <h1 class="article-title">${article.title}</h1>
                <p class="article-excerpt">${article.excerpt}</p>
                <div class="article-content">${article.content}</div>
            </div>`;
    }

    function buildEmailGate(article, preview) {
        const coverHTML = article.cover
            ? `<img class="article-hero-img" src="${article.cover}" alt="">`
            : `<div class="article-hero-emoji">${getEmoji(article)}</div>`;
        return `
            ${coverHTML}
            <div class="article-body">
                <div class="article-meta">
                    <span class="access-badge ${article.access}">${badgeLabel(article.access)}</span>
                    <span class="article-date">${formatDate(article.date)}</span>
                    <span class="article-readtime">¬∑ ${article.readtime} min de lecture</span>
                </div>
                <h1 class="article-title">${article.title}</h1>
                <p class="article-excerpt">${article.excerpt}</p>
                <div class="article-content">${preview}</div>
                <div class="gate-wrap">
                    <div class="gate-fade"></div>
                    <div class="gate-card">
                        <div class="gate-icon">üìß</div>
                        <div class="gate-title">Lis la suite gratuitement</div>
                        <ul class="gate-perks">
                            <li>Acc√®s √† tous les articles r√©serv√©s</li>
                            <li>Newsletters sant√© (2‚Äì3/mois)</li>
                            <li>Aucun spam, d√©sinscription facile</li>
                        </ul>
                        <form id="gate-form-${article.id}" data-article-id="${article.id}">
                            <input type="email" class="gate-input" placeholder="ton@email.fr" required autocomplete="email">
                            <button type="submit" class="gate-btn">Acc√©der √† la suite ‚Üí</button>
                            <div class="gate-success" id="gate-success-${article.id}">‚úì Acc√®s d√©bloqu√© ! Chargement‚Ä¶</div>
                        </form>
                        <p class="gate-disclaimer">Donn√©es trait√©es selon notre politique RGPD. D√©sinscription en 1 clic.</p>
                    </div>
                </div>
            </div>`;
    }

    function buildPremiumGate(article, preview) {
        const coverHTML = article.cover
            ? `<img class="article-hero-img" src="${article.cover}" alt="">`
            : `<div class="article-hero-emoji">${getEmoji(article)}</div>`;
        return `
            ${coverHTML}
            <div class="article-body">
                <div class="article-meta">
                    <span class="access-badge ${article.access}">${badgeLabel(article.access)}</span>
                    <span class="article-date">${formatDate(article.date)}</span>
                </div>
                <h1 class="article-title">${article.title}</h1>
                <p class="article-excerpt">${article.excerpt}</p>
                <div class="article-content">${preview}</div>
                <div class="gate-wrap">
                    <div class="gate-fade"></div>
                    <div class="gate-card">
                        <div class="gate-icon">‚≠ê</div>
                        <div class="gate-title">Contenu Boussole+</div>
                        <p style="font-size:14px;color:var(--color-text-muted);margin-top:8px;">Disponible prochainement dans la version premium.</p>
                    </div>
                </div>
            </div>`;
    }

    function setupGateForm(form, article) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = form.querySelector('input[type="email"]').value.trim();
            if (!email) return;
            const btn = form.querySelector('.gate-btn');
            btn.disabled = true;
            btn.textContent = 'Envoi‚Ä¶';
            try {
                await fetch(CONFIG.brevoFormURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `EMAIL=${encodeURIComponent(email)}`,
                    mode: 'no-cors'
                });
            } catch(e) { /* no-cors expected */ }

            localStorage.setItem(CONFIG.storageKey, 'true');
            state.isSubscriber = true;

            const success = document.getElementById('gate-success-' + article.id);
            if (success) { success.style.display = 'block'; btn.style.display = 'none'; }

            setTimeout(() => {
                document.getElementById('article-content-wrap').innerHTML = buildFullArticle(article);
                document.getElementById('article-overlay').scrollTop = 0;
                document.getElementById('subscriber-bar').classList.add('visible');
            }, 1500);
        });
    }

    function closeArticle() {
        const overlay = document.getElementById('article-overlay');
        overlay.classList.remove('open');
        document.body.style.overflow = '';
        document.getElementById('progress-bar').style.width = '0%';
        overlay.removeEventListener('scroll', updateProgress);
        renderCards(); // re-render avec acc√®s mis √† jour
    }

    function updateProgress() {
        const overlay = document.getElementById('article-overlay');
        const { scrollTop, scrollHeight, clientHeight } = overlay;
        const pct = scrollHeight > clientHeight
            ? (scrollTop / (scrollHeight - clientHeight)) * 100 : 0;
        document.getElementById('progress-bar').style.width = pct + '%';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EVENTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.getElementById('btn-back').addEventListener('click', closeArticle);

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeArticle();
    });

    // Swipe down to close
    let touchStartY = 0;
    const overlay = document.getElementById('article-overlay');
    overlay.addEventListener('touchstart', (e) => {
        touchStartY = e.touches[0].clientY;
    }, { passive: true });
    overlay.addEventListener('touchend', (e) => {
        const delta = e.changedTouches[0].clientY - touchStartY;
        if (delta > 80 && overlay.scrollTop < 10) closeArticle();
    }, { passive: true });

    // Search
    document.getElementById('search-input').addEventListener('input', (e) => {
        clearTimeout(state.searchTimer);
        state.searchTimer = setTimeout(() => {
            state.searchQuery = e.target.value.trim();
            applyFilters();
        }, 280);
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    loadArticles();
    </script>
</body>
</html>
