<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Articles â€” Boussole</title>
    <meta name="theme-color" content="#e09c8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Boussole">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           VARIABLES â€” cohÃ©rent avec index.html
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --color-primary: #e09c8a;
            --color-primary-dark: #c97d6a;
            --color-primary-light: #f5e6e1;
            --color-bg: #fafaf8;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-text-muted: #6b6b6b;
            --color-border: #ebebeb;
            --color-green: #4caf7d;
            --color-orange: #f0a055;
            --color-red: #e05c5c;
            --font-body: 'DM Sans', sans-serif;
            --font-serif: 'Lora', Georgia, serif;
            --radius: 14px;
            --shadow-card: 0 2px 12px rgba(0,0,0,0.07);
            --shadow-card-hover: 0 6px 24px rgba(0,0,0,0.12);
            --max-width: 680px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BASE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            padding: 16px;
            max-width: var(--max-width);
            margin: 0 auto;
            -webkit-font-smoothing: antialiased;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HEADER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .header {
            text-align: center;
            padding: 24px 0;
        }
        .header h1 {
            font-family: var(--font-serif);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--color-text);
        }
        .header p {
            font-size: 14px;
            color: var(--color-text-muted);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NAVIGATION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .nav {
            display: flex;
            gap: 8px;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 20px;
        }
        .nav-btn {
            flex: 1;
            padding: 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--color-text-muted);
            font-size: 16px;
            font-family: var(--font-body);
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn:hover { color: var(--color-text); background: rgba(224,156,138,.05); }
        .nav-btn.active {
            color: var(--color-primary-dark);
            border-bottom-color: var(--color-primary);
            font-weight: 600;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BARRE ABONNÃ‰
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .subscriber-bar {
            display: none;
            background: linear-gradient(135deg, #e8f7ef, #d4f0e4);
            border: 1px solid var(--color-green);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 14px;
            color: #2d7a50;
            font-weight: 500;
            margin-bottom: 16px;
            text-align: center;
        }
        .subscriber-bar.visible { display: block; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SEARCH + FILTRES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .search-wrap {
            position: relative;
            margin-bottom: 14px;
        }
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 15px;
            color: var(--color-text-muted);
            pointer-events: none;
        }
        #search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1.5px solid var(--color-border);
            border-radius: 10px;
            background: var(--color-surface);
            font-family: var(--font-body);
            font-size: 15px;
            color: var(--color-text);
            outline: none;
            transition: border-color 0.2s;
        }
        #search-input:focus { border-color: var(--color-primary); }
        #search-input::placeholder { color: var(--color-text-muted); }

        .filters {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            margin-bottom: 20px;
            scrollbar-width: none;
        }
        .filters::-webkit-scrollbar { display: none; }
        .chip {
            flex-shrink: 0;
            padding: 6px 14px;
            border-radius: 20px;
            border: 1.5px solid var(--color-border);
            background: var(--color-surface);
            font-size: 13px;
            font-family: var(--font-body);
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.18s;
            white-space: nowrap;
        }
        .chip:hover { border-color: var(--color-primary); color: var(--color-primary-dark); }
        .chip.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #fff;
            font-weight: 500;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CARDS FEED
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #feed {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-card);
            overflow: hidden;
            cursor: pointer;
            transition: box-shadow 0.2s, transform 0.15s;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-border);
            animation: cardIn 0.3s ease both;
        }
        @keyframes cardIn {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .card:hover {
            box-shadow: var(--shadow-card-hover);
            transform: translateY(-2px);
        }
        .card:active { transform: scale(0.99); }

        /* Image cover */
        .card-img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--color-primary-light) 0%, #f0e8e5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            flex-shrink: 0;
        }
        .card-img img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }
        .card-img.no-img { height: 80px; }

        /* Corps de la card */
        .card-body { padding: 16px; }

        .card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .access-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 9px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .access-badge.public  { background: #e8f7ef; color: #2d7a50; }
        .access-badge.inscrit { background: #fff3e0; color: #b06000; }
        .access-badge.premium { background: #f3e5f5; color: #7b1fa2; }

        .card-category {
            font-size: 12px;
            color: var(--color-text-muted);
            font-weight: 500;
        }
        .card-read-time {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-left: auto;
        }

        .card-title {
            font-family: var(--font-serif);
            font-size: 17px;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 8px;
            color: var(--color-text);
        }
        .card-excerpt {
            font-size: 14px;
            line-height: 1.6;
            color: var(--color-text-muted);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-locked {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 12px;
            background: var(--color-bg);
            border-radius: 8px;
            font-size: 13px;
            color: var(--color-text-muted);
        }
        .card-locked .lock-icon { font-size: 15px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODALE ARTICLE (lecture in-app)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .article-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--color-bg);
            z-index: 200;
            overflow-y: auto;
            animation: slideUp 0.25s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to   { transform: translateY(0); opacity: 1; }
        }
        .article-overlay.open { display: block; }

        .article-nav {
            position: sticky;
            top: 0;
            background: rgba(250,250,248,0.95);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--color-border);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10;
        }
        .back-btn {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: var(--color-text);
            padding: 4px;
            line-height: 1;
        }
        .article-nav-title {
            font-size: 15px;
            font-weight: 500;
            color: var(--color-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        .article-nav-badge { flex-shrink: 0; }

        .article-content {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 16px 80px;
        }

        .article-hero {
            width: calc(100% + 32px);
            margin-left: -16px;
            margin-right: -16px;
            height: 220px;
            object-fit: cover;
            display: block;
            background: linear-gradient(135deg, var(--color-primary-light), #f0e8e5);
        }
        .article-hero-emoji {
            width: calc(100% + 32px);
            margin-left: -16px;
            height: 120px;
            background: linear-gradient(135deg, var(--color-primary-light), #fde8e0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .article-header {
            padding: 24px 0 20px;
        }
        .article-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }
        .article-date {
            font-size: 13px;
            color: var(--color-text-muted);
        }
        .article-title {
            font-family: var(--font-serif);
            font-size: 22px;
            font-weight: 600;
            line-height: 1.35;
            color: var(--color-text);
            margin-bottom: 12px;
        }
        .article-excerpt-lead {
            font-size: 16px;
            line-height: 1.65;
            color: var(--color-text-muted);
            font-style: italic;
            border-left: 3px solid var(--color-primary);
            padding-left: 14px;
            margin-bottom: 24px;
        }

        /* Rendu HTML WordPress */
        .article-body { font-size: 15px; line-height: 1.75; color: var(--color-text); }
        .article-body h2 {
            font-family: var(--font-serif);
            font-size: 18px;
            font-weight: 600;
            margin: 28px 0 12px;
            color: var(--color-text);
        }
        .article-body h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 20px 0 8px;
        }
        .article-body p { margin-bottom: 16px; }
        .article-body ul, .article-body ol {
            margin: 0 0 16px 20px;
        }
        .article-body li { margin-bottom: 6px; }
        .article-body strong { font-weight: 600; }
        .article-body em { font-style: italic; }
        .article-body a { color: var(--color-primary-dark); text-decoration: underline; }
        .article-body blockquote {
            border-left: 3px solid var(--color-primary);
            padding: 10px 16px;
            margin: 20px 0;
            color: var(--color-text-muted);
            font-style: italic;
            background: var(--color-primary-light);
            border-radius: 0 8px 8px 0;
        }
        .article-body table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-bottom: 20px;
            overflow-x: auto;
            display: block;
        }
        .article-body th {
            background: var(--color-primary-light);
            font-weight: 600;
            padding: 8px 10px;
            text-align: left;
            border-bottom: 2px solid var(--color-primary);
        }
        .article-body td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--color-border);
        }
        .article-body tr:hover td { background: var(--color-bg); }

        /* TronquÃ© pour articles gate */
        .article-truncated { position: relative; }
        .article-fade {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(transparent, var(--color-bg));
        }

        /* Gate email in-article */
        .article-gate {
            background: var(--color-surface);
            border: 1.5px solid var(--color-border);
            border-radius: var(--radius);
            padding: 28px 24px;
            text-align: center;
            margin-top: 8px;
        }
        .article-gate h3 {
            font-family: var(--font-serif);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .article-gate p {
            font-size: 14px;
            color: var(--color-text-muted);
            line-height: 1.55;
            margin-bottom: 20px;
        }
        .gate-benefits {
            list-style: none;
            margin-bottom: 20px;
            text-align: left;
            display: inline-block;
        }
        .gate-benefits li {
            font-size: 14px;
            color: var(--color-text-muted);
            padding: 4px 0;
        }
        .gate-benefits li::before {
            content: "âœ“ ";
            color: var(--color-green);
            font-weight: 600;
        }
        .gate-form { display: flex; flex-direction: column; gap: 10px; }
        .gate-input {
            width: 100%;
            padding: 13px 16px;
            border: 1.5px solid var(--color-border);
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s;
            background: var(--color-bg);
        }
        .gate-input:focus { border-color: var(--color-primary); }
        .gate-btn {
            width: 100%;
            padding: 14px;
            background: var(--color-primary);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .gate-btn:hover { background: var(--color-primary-dark); }
        .gate-btn:disabled { background: #ccc; cursor: default; }
        .gate-disclaimer {
            font-size: 11px;
            color: var(--color-text-muted);
            margin-top: 4px;
        }
        .gate-success {
            display: none;
            background: #e8f7ef;
            border-radius: 10px;
            padding: 16px;
            color: #2d7a50;
            font-weight: 500;
            font-size: 15px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           Ã‰TATS VIDES / LOADING
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .skeleton-list { display: flex; flex-direction: column; gap: 14px; }
        .skeleton-card {
            background: var(--color-surface);
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
            overflow: hidden;
        }
        .skeleton-img {
            height: 140px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.4s infinite;
        }
        .skeleton-body { padding: 16px; }
        .skeleton-line {
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.4s infinite;
            margin-bottom: 10px;
        }
        .skeleton-line.short { width: 60%; }
        .skeleton-line.med   { width: 80%; }
        @keyframes shimmer {
            0%   { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-muted);
        }
        .empty-state .icon { font-size: 36px; margin-bottom: 12px; }
        .empty-state p { font-size: 15px; line-height: 1.5; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOAD MORE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #load-more-wrap { text-align: center; margin: 24px 0 8px; }
        #load-more-btn {
            background: none;
            border: 1.5px solid var(--color-border);
            border-radius: 10px;
            padding: 12px 28px;
            font-family: var(--font-body);
            font-size: 14px;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        #load-more-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary-dark);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SCROLL PROGRESS (article)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: var(--color-primary);
            width: 0%;
            z-index: 300;
            transition: width 0.1s linear;
            display: none;
        }
        .progress-bar.visible { display: block; }
    </style>
</head>
<body>

    <!-- PROGRESS BAR lecture -->
    <div class="progress-bar" id="progress-bar"></div>

    <!-- HEADER -->
    <header class="header">
        <h1>Articles</h1>
        <p>La science au service de votre santÃ©</p>
    </header>

    <!-- NAVIGATION -->
    <nav class="nav" role="navigation">
        <a class="nav-btn" href="/" aria-label="Aujourd'hui">Aujourd'hui</a>
        <a class="nav-btn" href="/?panel=summary" aria-label="RÃ©sumÃ©">RÃ©sumÃ©</a>
        <a class="nav-btn active" href="/articles.html" aria-label="Articles" aria-current="page">Articles</a>
    </nav>

    <!-- BARRE ABONNÃ‰ -->
    <div class="subscriber-bar" id="subscriber-bar">âœ“ AccÃ¨s complet â€” bienvenue !</div>

    <!-- RECHERCHE -->
    <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="search" id="search-input" placeholder="Rechercher un article..." autocomplete="off">
    </div>

    <!-- FILTRES CATÃ‰GORIES -->
    <div class="filters" id="filters">
        <button class="chip active" data-cat="all">Tous</button>
        <!-- Les catÃ©gories sont injectÃ©es dynamiquement -->
    </div>

    <!-- FEED -->
    <main id="feed" role="main" aria-label="Liste des articles"></main>
    <div id="load-more-wrap" style="display:none">
        <button id="load-more-btn">Charger plus d'articles</button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MODALE ARTICLE â€” lecture in-app
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="article-overlay" id="article-overlay" role="dialog" aria-modal="true" aria-label="Article">
        <div class="article-nav">
            <button class="back-btn" id="back-btn" aria-label="Retour">â†</button>
            <span class="article-nav-title" id="article-nav-title"></span>
            <span class="article-nav-badge" id="article-nav-badge"></span>
        </div>
        <div class="article-content" id="article-content">
            <!-- Contenu injectÃ© par JS -->
        </div>
    </div>

    <script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONFIG
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const CONFIG = {
        apiBase: 'https://micronutriment.fr/wp-json/wp/v2',
        perPage: 10,
        brevoFormURL: 'https://ffd96913.sibforms.com/serve/MUIFAJUmjQTMcr8EIjmLErqYjjECrQ73i0aPhf_n6tBk2T-Z5AzjIeTGaQAcaPFU0Gg_yPaV46hxNb6EtRVWlzHZOM4fH08S6nOFuz5CNcfhisSD5UFAsEOsTMl8w405AGiQRhn3MyOfmYSaCUtoAMGqVRzRXKkdXN2kjT-18CVH688z0YTCeL_NKQzYUcFCGw44EksGyMRhKlBtUw==',
        accessLevels: {
            'public': 'public',
            'inscrit': 'inscrit',
            'premium': 'premium'
        }
    };

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Ã‰TAT GLOBAL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let state = {
        allArticles: [],     // tous les articles chargÃ©s
        filtered: [],        // articles aprÃ¨s filtre+recherche
        displayed: 0,        // nb affichÃ© actuellement
        page: 1,
        totalPages: 1,
        loading: false,
        currentArticle: null,
        activeCategory: 'all',
        searchQuery: '',
        categories: {},      // id â†’ name
        isSubscriber: localStorage.getItem('boussole_email_verified') === 'true'
    };

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       UTILITAIRES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function getAccessLevel(article) {
        const tags = article._embedded?.['wp:term']?.flat() || [];
        if (tags.some(t => t.slug === 'premium')) return 'premium';
        if (tags.some(t => t.slug === 'inscrit')) return 'inscrit';
        return 'public';
    }

    function canAccess(article) {
        const level = getAccessLevel(article);
        if (level === 'public') return true;
        if (level === 'premium') return false;
        return state.isSubscriber;
    }

    function readTime(html) {
        const text = html.replace(/<[^>]+>/g, '');
        const words = text.trim().split(/\s+/).length;
        const mins = Math.max(1, Math.round(words / 200));
        return mins + ' min';
    }

    function formatDate(dateStr) {
        const d = new Date(dateStr);
        return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function stripHtml(html) {
        return html.replace(/<[^>]+>/g, '').replace(/&[^;]+;/g, ' ').trim();
    }

    function getCoverImage(article) {
        // 1. Image Ã  la une via _embedded
        const media = article._embedded?.['wp:featuredmedia']?.[0];
        if (media?.source_url) return media.source_url;
        // 2. PremiÃ¨re image dans le contenu
        const match = article.content?.rendered?.match(/<img[^>]+src=["']([^"']+)["']/);
        if (match) return match[1];
        return null;
    }

    function getEmoji(article) {
        const title = article.title.rendered;
        const cats = article._embedded?.['wp:term']?.flat()?.map(t => t.slug) || [];
        if (cats.includes('fatigue') || title.includes('fatigue') || title.includes('Ã©nergie')) return 'âš¡';
        if (cats.includes('sommeil') || title.includes('sommeil')) return 'ğŸ˜´';
        if (cats.includes('covid') || title.includes('Covid')) return 'ğŸ¦ ';
        if (cats.includes('microbiote') || title.includes('microbiote') || title.includes('intestin')) return 'ğŸ¦ ';
        if (title.includes('magnÃ©sium') || title.includes('MagnÃ©sium')) return 'ğŸ’Š';
        if (title.includes('nutrition') || cats.includes('nutrition')) return 'ğŸ¥—';
        if (title.includes('cerveau') || title.includes('mental')) return 'ğŸ§ ';
        if (title.includes('douleur') || title.includes('fibro')) return 'ğŸ©º';
        if (title.includes('hormone') || title.includes('mÃ©no')) return 'âš–ï¸';
        return 'ğŸ“–';
    }

    function badgeHTML(level) {
        const labels = { public: 'Gratuit', inscrit: 'Inscrit', premium: 'Premium' };
        return `<span class="access-badge ${level}">${labels[level]}</span>`;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       API WORDPRESS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function fetchArticles(page = 1) {
        const url = `${CONFIG.apiBase}/posts?per_page=${CONFIG.perPage}&page=${page}&_embed=true&status=publish&orderby=date&order=desc`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`API error ${res.status}`);
        const total = parseInt(res.headers.get('X-WP-TotalPages') || '1');
        state.totalPages = total;
        return res.json();
    }

    async function fetchCategories() {
        try {
            const res = await fetch(`${CONFIG.apiBase}/categories?per_page=20&hide_empty=true`);
            const cats = await res.json();
            cats.forEach(c => { state.categories[c.id] = c.name; });
        } catch(e) { /* silencieux */ }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RENDU FEED
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderSkeleton() {
        const feed = document.getElementById('feed');
        feed.innerHTML = `
            <div class="skeleton-list">
                ${[1,2,3].map(() => `
                    <div class="skeleton-card">
                        <div class="skeleton-img"></div>
                        <div class="skeleton-body">
                            <div class="skeleton-line short"></div>
                            <div class="skeleton-line med"></div>
                            <div class="skeleton-line"></div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderCards(articles, append = false) {
        const feed = document.getElementById('feed');
        if (!append) feed.innerHTML = '';

        if (articles.length === 0 && !append) {
            feed.innerHTML = `
                <div class="empty-state">
                    <div class="icon">ğŸ”</div>
                    <p>Aucun article trouvÃ©.<br>Essaie un autre mot-clÃ©.</p>
                </div>
            `;
            return;
        }

        articles.forEach((article, idx) => {
            const level = getAccessLevel(article);
            const locked = !canAccess(article);
            const imgUrl = getCoverImage(article);
            const emoji = getEmoji(article);
            const title = article.title.rendered;
            const excerptRaw = article.excerpt?.rendered || '';
            const excerpt = stripHtml(excerptRaw).slice(0, 140) + (stripHtml(excerptRaw).length > 140 ? 'â€¦' : '');
            const rtime = readTime(article.content?.rendered || '');

            // CatÃ©gorie principale
            const primaryCat = article._embedded?.['wp:term']?.[0]?.[0]?.name || '';

            const imgHTML = imgUrl
                ? `<div class="card-img"><img src="${imgUrl}" alt="" loading="lazy"></div>`
                : `<div class="card-img no-img"><span>${emoji}</span></div>`;

            const lockHTML = locked ? `
                <div class="card-locked">
                    <span class="lock-icon">${level === 'premium' ? 'â­' : 'ğŸ“§'}</span>
                    <span>${level === 'premium' ? 'Disponible en version premium' : 'Inscris-toi pour lire cet article'}</span>
                </div>
            ` : '';

            const card = document.createElement('article');
            card.className = 'card';
            card.style.animationDelay = `${idx * 0.05}s`;
            card.setAttribute('data-id', article.id);
            card.innerHTML = `
                ${imgHTML}
                <div class="card-body">
                    <div class="card-meta">
                        ${badgeHTML(level)}
                        ${primaryCat ? `<span class="card-category">${primaryCat}</span>` : ''}
                        <span class="card-read-time">â± ${rtime}</span>
                    </div>
                    <h2 class="card-title">${title}</h2>
                    <p class="card-excerpt">${excerpt}</p>
                    ${lockHTML}
                </div>
            `;
            card.addEventListener('click', () => openArticle(article));
            feed.appendChild(card);
        });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FILTRES & RECHERCHE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function applyFilters() {
        let results = [...state.allArticles];

        // Filtre catÃ©gorie
        if (state.activeCategory !== 'all') {
            results = results.filter(a => {
                const cats = a._embedded?.['wp:term']?.[0] || [];
                return cats.some(c => String(c.id) === state.activeCategory);
            });
        }

        // Filtre recherche
        if (state.searchQuery) {
            const q = state.searchQuery.toLowerCase();
            results = results.filter(a =>
                a.title.rendered.toLowerCase().includes(q) ||
                stripHtml(a.excerpt?.rendered || '').toLowerCase().includes(q)
            );
        }

        state.filtered = results;
        renderCards(state.filtered);
        updateLoadMore();
    }

    function buildCategoryFilters() {
        const filtersEl = document.getElementById('filters');
        // Collecter catÃ©gories prÃ©sentes dans les articles chargÃ©s
        const catMap = {};
        state.allArticles.forEach(a => {
            const cats = a._embedded?.['wp:term']?.[0] || [];
            cats.forEach(c => { catMap[c.id] = c.name; });
        });
        // Ajouter chips (garder le chip "Tous")
        Object.entries(catMap).slice(0, 8).forEach(([id, name]) => {
            const chip = document.createElement('button');
            chip.className = 'chip';
            chip.dataset.cat = id;
            chip.textContent = name;
            chip.addEventListener('click', () => {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                state.activeCategory = id;
                applyFilters();
            });
            filtersEl.appendChild(chip);
        });
    }

    function updateLoadMore() {
        const wrap = document.getElementById('load-more-wrap');
        wrap.style.display = state.page < state.totalPages && state.searchQuery === '' && state.activeCategory === 'all'
            ? 'block' : 'none';
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MODALE ARTICLE â€” ouverture
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function openArticle(article) {
        state.currentArticle = article;
        const overlay = document.getElementById('article-overlay');
        const content = document.getElementById('article-content');
        const navTitle = document.getElementById('article-nav-title');
        const navBadge = document.getElementById('article-nav-badge');
        const progressBar = document.getElementById('progress-bar');

        const level = getAccessLevel(article);
        const locked = !canAccess(article);
        const imgUrl = getCoverImage(article);
        const emoji = getEmoji(article);
        const title = article.title.rendered;
        const date = formatDate(article.date);
        const rtime = readTime(article.content?.rendered || '');
        const excerptRaw = stripHtml(article.excerpt?.rendered || '');

        navTitle.textContent = stripHtml(title);
        navBadge.innerHTML = badgeHTML(level);

        let bodyHTML = article.content?.rendered || '';

        // Si locked : tronquer Ã  ~40% du contenu
        let gateHTML = '';
        if (locked) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = bodyHTML;
            const paragraphs = tempDiv.querySelectorAll('p, h2, h3, ul, ol, blockquote, table');
            const cutAt = Math.max(2, Math.floor(paragraphs.length * 0.35));
            let truncated = '';
            paragraphs.forEach((el, i) => { if (i < cutAt) truncated += el.outerHTML; });
            bodyHTML = truncated;
            gateHTML = buildGate(level, article.id);
        }

        const heroHTML = imgUrl
            ? `<img class="article-hero" src="${imgUrl}" alt="">`
            : `<div class="article-hero-emoji">${emoji}</div>`;

        content.innerHTML = `
            ${heroHTML}
            <div class="article-header">
                <div class="article-meta">
                    ${badgeHTML(level)}
                    <span class="article-date">${date} Â· ${rtime} de lecture</span>
                </div>
                <h1 class="article-title">${title}</h1>
                ${excerptRaw ? `<p class="article-excerpt-lead">${excerptRaw.slice(0,200)}${excerptRaw.length > 200 ? 'â€¦' : ''}</p>` : ''}
            </div>
            ${locked
                ? `<div class="article-truncated">
                       <div class="article-body">${bodyHTML}</div>
                       <div class="article-fade"></div>
                   </div>
                   ${gateHTML}`
                : `<div class="article-body">${bodyHTML}</div>`
            }
        `;

        overlay.classList.add('open');
        overlay.scrollTop = 0;
        progressBar.classList.add('visible');
        progressBar.style.width = '0%';
        document.body.style.overflow = 'hidden';

        // Scroll progress
        overlay.onscroll = () => {
            const scrolled = overlay.scrollTop;
            const total = overlay.scrollHeight - overlay.clientHeight;
            const pct = total > 0 ? (scrolled / total) * 100 : 0;
            progressBar.style.width = pct + '%';
        };
    }

    function closeArticle() {
        const overlay = document.getElementById('article-overlay');
        const progressBar = document.getElementById('progress-bar');
        overlay.classList.remove('open');
        progressBar.classList.remove('visible');
        document.body.style.overflow = '';
        state.currentArticle = null;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GATE EMAIL â€” in-article
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function buildGate(level, articleId) {
        if (level === 'premium') {
            return `
                <div class="article-gate">
                    <div style="font-size:32px;margin-bottom:12px">â­</div>
                    <h3>Contenu premium</h3>
                    <p>Cet article sera disponible dans la version Boussole+ (bientÃ´t).</p>
                </div>
            `;
        }
        return `
            <div class="article-gate" id="gate-${articleId}">
                <div style="font-size:32px;margin-bottom:12px">ğŸ“§</div>
                <h3>Lis la suite gratuitement</h3>
                <p>Rejoins les lecteurs qui reÃ§oivent mes analyses chaque semaine.</p>
                <ul class="gate-benefits">
                    <li>AccÃ¨s Ã  tous les articles "Inscrit"</li>
                    <li>Newsletters hebdomadaires</li>
                    <li>Aucun spam, dÃ©sinscription Ã  tout moment</li>
                </ul>
                <div class="gate-form">
                    <input type="email" class="gate-input" id="gate-email-${articleId}" placeholder="ton@email.fr" autocomplete="email">
                    <button class="gate-btn" onclick="submitGate('${articleId}')">AccÃ©der Ã  la suite â†’</button>
                    <p class="gate-disclaimer">Gratuit Â· RGPD Â· DÃ©sinscription en 1 clic</p>
                </div>
                <div class="gate-success" id="gate-success-${articleId}">
                    âœ“ Merci ! Actualise la page pour lire l'article complet.
                </div>
            </div>
        `;
    }

    window.submitGate = async function(articleId) {
        const emailInput = document.getElementById(`gate-email-${articleId}`);
        const btn = emailInput?.closest('.gate-form')?.querySelector('.gate-btn');
        const email = emailInput?.value?.trim();

        if (!email || !email.includes('@')) {
            emailInput.style.borderColor = 'var(--color-red)';
            return;
        }

        if (btn) { btn.disabled = true; btn.textContent = 'Envoiâ€¦'; }

        try {
            // POST Brevo en no-cors (mode opaque)
            await fetch(CONFIG.brevoFormURL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `EMAIL=${encodeURIComponent(email)}`
            });
        } catch(e) { /* no-cors always throws â€” expected */ }

        // Activer l'accÃ¨s
        localStorage.setItem('boussole_email_verified', 'true');
        state.isSubscriber = true;

        // Afficher succÃ¨s
        const gate = document.getElementById(`gate-${articleId}`);
        if (gate) {
            gate.querySelector('.gate-form').style.display = 'none';
            document.getElementById(`gate-success-${articleId}`).style.display = 'block';
        }

        // Recharger l'article aprÃ¨s 1.5s
        setTimeout(() => {
            if (state.currentArticle) openArticle(state.currentArticle);
            document.getElementById('subscriber-bar').classList.add('visible');
        }, 1500);
    };

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INIT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function init() {
        // Barre abonnÃ©
        if (state.isSubscriber) {
            document.getElementById('subscriber-bar').classList.add('visible');
        }

        renderSkeleton();

        try {
            const [articles] = await Promise.all([
                fetchArticles(1),
                fetchCategories()
            ]);

            state.allArticles = articles;
            state.page = 1;
            state.filtered = [...articles];

            buildCategoryFilters();
            renderCards(state.filtered);
            updateLoadMore();
        } catch(e) {
            document.getElementById('feed').innerHTML = `
                <div class="empty-state">
                    <div class="icon">ğŸ“¡</div>
                    <p>Impossible de charger les articles.<br>VÃ©rifie ta connexion.</p>
                </div>
            `;
            console.error('Init error:', e);
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Ã‰VÃ‰NEMENTS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    // Bouton retour (modale article)
    document.getElementById('back-btn').addEventListener('click', closeArticle);

    // Swipe down pour fermer (mobile)
    let touchStartY = 0;
    document.getElementById('article-overlay').addEventListener('touchstart', e => {
        touchStartY = e.touches[0].clientY;
    }, { passive: true });
    document.getElementById('article-overlay').addEventListener('touchend', e => {
        const delta = e.changedTouches[0].clientY - touchStartY;
        const overlay = document.getElementById('article-overlay');
        if (delta > 80 && overlay.scrollTop < 10) closeArticle();
    }, { passive: true });

    // Touche Escape
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeArticle();
    });

    // Chip "Tous"
    document.querySelector('.chip[data-cat="all"]').addEventListener('click', () => {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        document.querySelector('.chip[data-cat="all"]').classList.add('active');
        state.activeCategory = 'all';
        applyFilters();
    });

    // Recherche avec debounce
    let searchTimer;
    document.getElementById('search-input').addEventListener('input', e => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
            state.searchQuery = e.target.value.trim();
            applyFilters();
        }, 280);
    });

    // Load more
    document.getElementById('load-more-btn').addEventListener('click', async () => {
        if (state.loading || state.page >= state.totalPages) return;
        state.loading = true;
        const btn = document.getElementById('load-more-btn');
        btn.textContent = 'Chargementâ€¦';
        try {
            state.page++;
            const more = await fetchArticles(state.page);
            state.allArticles.push(...more);
            state.filtered.push(...more);
            renderCards(more, true);
            updateLoadMore();
        } catch(e) { state.page--; }
        state.loading = false;
        btn.textContent = 'Charger plus d\'articles';
    });

    // Lancer
    init();
    </script>
</body>
</html>
